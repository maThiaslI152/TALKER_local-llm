-- talker_debug_hud.script
local tracker = require("framework.debug_tracker")
local log = require("framework.logger")

class "DebugHUD" (CUIScriptWnd)

function DebugHUD:__init() super()
	self:InitControls()
	self:Show(true)
end

function DebugHUD:__finalize()
end

function DebugHUD:InitControls()
	self:SetWndRect(Frect():set(0,0,1024,768))
	self.xml = CScriptXmlInit()
	self.xml:ParseFile("talker_debug.xml")

	self.ui = {}
	self.ui.main = self.xml:InitStatic("main", self)
    -- Removed background as requested
    -- self.xml:InitStatic("background", self.ui.main)
	self.ui.limit_text = self.xml:InitTextWnd("limit_text", self.ui.main)

    self.ui.lines = {}
    self.ui.lines["Triggered"]      = self.xml:InitTextWnd("line_triggered", self.ui.main)
    self.ui.lines["Choosing Actor"] = self.xml:InitTextWnd("line_choosing", self.ui.main)
    self.ui.lines["Memory Store"]   = self.xml:InitTextWnd("line_memory", self.ui.main)
    self.ui.lines["Sent to LLM"]    = self.xml:InitTextWnd("line_llm", self.ui.main)
    self.ui.lines["Response"]       = self.xml:InitTextWnd("line_response", self.ui.main)
    
    self:Register(self.ui.main, "main_window")
end

function DebugHUD:Update()
	CUIScriptWnd.Update(self)
    
	-- Auto-reset tracker if stale (5 seconds after finish/fail)
	tracker.check_auto_reset(5)
    
	local state = tracker.get_state()
	
	-- Update Title with Fail Reason or just Debug
	local title = "TALKER DEBUG"
	if state.fail_reason then
		title = title .. " - FAILED: " .. state.fail_reason
		self.ui.limit_text:SetTextColor(GetARGB(255, 255, 50, 50)) -- Red
	else
		self.ui.limit_text:SetTextColor(GetARGB(255, 255, 255, 255)) -- White
	end
	self.ui.limit_text:SetText(title)
	
	for _, stage in ipairs(state.stages) do
		local line = self.ui.lines[stage.name]
		if line then
			local text = stage.name .. ": " .. stage.status
            
            -- Append Info if available
            if stage.info then
                text = text .. " (" .. stage.info .. ")"
            end
            
			if stage.duration then
				text = text .. string.format(" (%.2fs)", stage.duration)
			elseif stage.status == "running" then
				-- show live timer
				local start = state.start_times[stage.name] or os.clock()
				local current = os.clock() - start
				text = text .. string.format(" (%.2fs)", current)
			end
			
			-- Color coding
			if stage.status == "running" then
				line:SetTextColor(GetARGB(255, 255, 255, 0)) -- Yellow
			elseif stage.status == "done" then
				line:SetTextColor(GetARGB(255, 0, 255, 0)) -- Green
			elseif stage.status == "failed" then
				line:SetTextColor(GetARGB(255, 255, 50, 50)) -- Red
			else
				line:SetTextColor(GetARGB(255, 100, 100, 100)) -- Gray
			end
			
			line:SetText(text)
		end
	end
end

local config = require("interface.config")

-- ... (DebugHUD class remains) ...

 -- Singleton management via config polling
local hud_instance = nil

function show()
    if not hud_instance then
        hud_instance = DebugHUD()
    end
    hud_instance:Show(true)
    get_hud():AddDialogToRender(hud_instance)
end

function hide()
    if hud_instance then
        get_hud():RemoveDialogToRender(hud_instance)
        hud_instance:Show(false)
        hud_instance = nil
    end
end

local last_check = 0
function on_actor_update()
    local tg = time_global()
    if tg < last_check + 1000 then return end -- Check every 1s
    last_check = tg
    
    local enabled = config.debug_enabled()
    if enabled and not hud_instance then
        show()
    elseif not enabled and hud_instance then
        hide()
    end
end

function on_game_start()
    RegisterScriptCallback("actor_on_update", on_actor_update)
end
